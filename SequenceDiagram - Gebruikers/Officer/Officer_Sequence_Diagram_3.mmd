%% 3. Ambtenaar markeert melding als opgelost (upload foto, status -> RESOLVED)

%%{init: {'theme':'base','themeVariables':{
  'lineColor':'blue','primaryColor':'blue','primaryTextColor':'green','textColor':'green','mainBkg':'#FFFFFF'
}}}%%
sequenceDiagram
    actor Officer
    participant Frontend
    participant Backend
    participant ReportService
    participant MediaService
    participant Database
    participant NotificationService

    Note over Officer: Ambtenaar lost melding op en uploadt foto

    Officer->>+Frontend: Upload resolvedPhoto + klik "Markeer opgelost"
    Frontend->>+Backend: PATCH /api/reports/123/resolve {photoUrl, comment}
    Backend->>+MediaService: storeMedia(photoFile)  -->> MediaService: returns photoUrl
    MediaService->>+Database: INSERT report_media_entity(report_id=123, url=photoUrl)
    Database-->>-MediaService: ok
    Backend->>+ReportService: resolveReport(123, officerId=456, photoUrl, comment)
    ReportService->>+Database: UPDATE reports SET status=RESOLVED, resolvedAt=now() WHERE id=123
    Database-->>-ReportService: OK
    ReportService->>+Database: INSERT status_updates (previous=IN_PROGRESS, new=RESOLVED, ...)
    Database-->>-ReportService: OK
    ReportService->>+Database: INSERT report_status_history (status=RESOLVED, resolvedPhotoUrl=photoUrl, ...)
    Database-->>-ReportService: OK
    ReportService->>+NotificationService: notifyCitizen(userId, "Uw melding is opgelost")
    NotificationService-->>-ReportService: OK
    ReportService-->>-Backend: ResolvedReport
    Backend-->>-Frontend: 200 OK
    Frontend-->>-Officer: Bevestiging: "Melding gemarkeerd als opgelost"